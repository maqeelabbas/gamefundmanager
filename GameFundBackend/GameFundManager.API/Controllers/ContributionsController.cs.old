using GameFundManager.Application.DTOs;
using GameFundManager.Application.Interfaces;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Swashbuckle.AspNetCore.Annotations;
using Swashbuckle.AspNetCore.Filters;

namespace GameFundManager.API.Controllers
{
    [Authorize]
    public class ContributionsController : BaseApiController
    {
        private readonly IContributionService _contributionService;

        public ContributionsController(IContributionService contributionService)
        {
            _contributionService = contributionService;
        }        /// <summary>
        /// Get all contributions for a specific group
        /// </summary>
        /// <param name="groupId">Group ID to retrieve contributions for</param>
        /// <returns>List of contributions for the specified group</returns>
        [HttpGet("group/{groupId}")]
        [SwaggerOperation(
            Summary = "Get group contributions", 
            Description = "Returns all contributions made to a specific group",
            OperationId = "GetGroupContributions",
            Tags = new[] { "Contributions" }
        )]
        [SwaggerResponse(200, "Group contributions retrieved successfully", typeof(List<ContributionDto>))]
        [SwaggerResponse(404, "Group not found")]
        [SwaggerResponse(401, "Unauthorized access")]
        [SwaggerResponseExample(200, "{\"success\":true,\"message\":\"Group contributions retrieved successfully\",\"data\":[{\"id\":\"3fa85f64-5717-4562-b3fc-2c963f66afa6\",\"groupId\":\"3fa85f64-5717-4562-b3fc-2c963f66afa6\",\"groupName\":\"Cricket Team\",\"userId\":\"3fa85f64-5717-4562-b3fc-2c963f66afa6\",\"contributorName\":\"John Doe\",\"amount\":50.00,\"contributionDate\":\"2023-08-15T10:30:00\",\"notes\":\"Monthly contribution\",\"paymentMethod\":\"CreditCard\"}],\"errors\":null}")]
        public async Task<IActionResult> GetGroupContributions(
            [SwaggerExample("3fa85f64-5717-4562-b3fc-2c963f66afa6", "Group ID to retrieve contributions for")]
            Guid groupId)
        {
            var response = await _contributionService.GetGroupContributionsAsync(groupId);
            return HandleApiResponse(response);
        }

        /// <summary>
        /// Get all contributions made by the current user
        /// </summary>
        /// <returns>List of contributions made by the current user</returns>
        [HttpGet("user")]
        [SwaggerOperation(
            Summary = "Get user contributions", 
            Description = "Returns all contributions made by the current authenticated user",
            OperationId = "GetUserContributions",
            Tags = new[] { "Contributions" }
        )]
        [SwaggerResponse(200, "User contributions retrieved successfully", typeof(List<ContributionDto>))]
        [SwaggerResponse(401, "Unauthorized access")]
        [SwaggerResponseExample(200, "{\"success\":true,\"message\":\"User contributions retrieved successfully\",\"data\":[{\"id\":\"3fa85f64-5717-4562-b3fc-2c963f66afa6\",\"groupId\":\"3fa85f64-5717-4562-b3fc-2c963f66afa6\",\"groupName\":\"Cricket Team\",\"userId\":\"3fa85f64-5717-4562-b3fc-2c963f66afa6\",\"contributorName\":\"John Doe\",\"amount\":50.00,\"contributionDate\":\"2023-08-15T10:30:00\",\"notes\":\"Monthly contribution\",\"paymentMethod\":\"CreditCard\"}],\"errors\":null}")]
        public async Task<IActionResult> GetUserContributions()
        {
            var userId = GetCurrentUserId();
            var response = await _contributionService.GetUserContributionsAsync(userId);
            return HandleApiResponse(response);
        }

        /// <summary>
        /// Get a specific contribution by ID
        /// </summary>
        /// <param name="id">Contribution ID to retrieve</param>
        /// <returns>Details of the specified contribution</returns>
        [HttpGet("{id}")]
        [SwaggerOperation(
            Summary = "Get contribution by ID", 
            Description = "Returns detailed information about a specific contribution",
            OperationId = "GetContributionById",
            Tags = new[] { "Contributions" }
        )]
        [SwaggerResponse(200, "Contribution retrieved successfully", typeof(ContributionDto))]
        [SwaggerResponse(404, "Contribution not found")]
        [SwaggerResponse(401, "Unauthorized access")]
        [SwaggerResponseExample(200, "{\"success\":true,\"message\":\"Contribution retrieved successfully\",\"data\":{\"id\":\"3fa85f64-5717-4562-b3fc-2c963f66afa6\",\"groupId\":\"3fa85f64-5717-4562-b3fc-2c963f66afa6\",\"groupName\":\"Cricket Team\",\"userId\":\"3fa85f64-5717-4562-b3fc-2c963f66afa6\",\"contributorName\":\"John Doe\",\"amount\":50.00,\"contributionDate\":\"2023-08-15T10:30:00\",\"notes\":\"Monthly contribution\",\"paymentMethod\":\"CreditCard\"},\"errors\":null}")]
        public async Task<IActionResult> GetContributionById(
            [SwaggerExample("3fa85f64-5717-4562-b3fc-2c963f66afa6", "Contribution ID to retrieve")]
            Guid id)
        {
            var response = await _contributionService.GetContributionByIdAsync(id);
            return HandleApiResponse(response);
        }

        [HttpPost]
        public async Task<IActionResult> AddContribution([FromBody] CreateContributionDto contributionDto)
        {
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            var userId = GetCurrentUserId();
            var response = await _contributionService.AddContributionAsync(contributionDto, userId);
            return HandleApiResponse(response);
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteContribution(Guid id)
        {
            var userId = GetCurrentUserId();
            var response = await _contributionService.DeleteContributionAsync(id, userId);
            return HandleApiResponse(response);
        }
    }
}
